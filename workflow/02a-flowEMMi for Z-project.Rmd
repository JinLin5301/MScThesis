---
title: "02a-flowEMMi for-Z-project"
date: "Compiled at `r format(Sys.time(), '%Y-%m-%d %H:%M:%S', tz = 'UTC')` UTC"
output: github_document
params:
  name: "02a-flowEMMi-for-Z-project" # change if you rename file
---

```{r here, message=FALSE}
here::i_am(paste0(params$name, ".Rmd"), uuid = "11675b32-9913-442e-9b4a-03cdc39afb65")
```

The purpose of this document is ...

```{r packages,message=FALSE}
library("conflicted")
library(purrr)
library(dplyr)
library(mvtnorm)
library(flowEMMi)
library(flowCore)
library(ggcyto)
library(tidyverse)
library(RColorBrewer)
library(knitr)
library(ellipse)
library(ggforce)
library(ROCR)
library(ggplot2)
```

```{r directories}
# create or *empty* the target directory, used to write this file's data: 
projthis::proj_create_dir_target(params$name, clean = TRUE)

# function to get path to target directory: path_target("sample.csv")
path_target <- projthis::proj_path_target(params$name)

# function to get path to previous data: path_source("00-import", "sample.csv")
path_source <- projthis::proj_path_source(params$name)
```

## Z-project

### Import preprocessed data

```{r import,message=FALSE}
DAPI <- readRDS("~/Desktop/MSc_new_data/new_DAPI.rds")
gating_DAPI <- readRDS("~/Desktop/MSc_new_data/gating_DAPI.rds")
```

### flowEMMI gating on DAPI

Based on the scatter plot in 01-data, we could tell that except for the sample taken in the surrounding region, the cells of other region samples are mostly concentrated in the range of 20000 to 60000.

Therefore, we will run the automated gating on surrounding region and other regions respectively.

-   Setting range for other regions: 20000-50000

-   Setting range for Surrounding region: 1000-50000

```{r flowEMMI-DAPI,results='hide',eval=F}
set.seed(1)
location <- c("Inner_zone","Middle_zone","Outer_zone","Whole_colony","Surrounding")
gating_DAPI <- list()

for (i in 1:4){
  data_name <- paste0(location[i],"_DAPI.fcs")
  data <- DAPI[[i]]
  fdo <- mkFlowDataObject(data, xChannel="PMT.1", yChannel="PMT.9")
  gating <- flowEMMi( fdo=fdo, xMin=20000, xMax=50000, yMin=20000, yMax=50000
                      , initFraction=0.01
                      , finalFraction=1.0
                      , minClusters=5, maxClusters=15, clusterbracket=2
                      , numberOfInits=5
                      , verbose=TRUE
                      , parallel=FALSE
                      , convergenceEpsilon=0.01
                      , whenToRemoveOverlaps = 20
                      , mergeWhenCenter = FALSE
                      , mergeWhenTwoCenters = FALSE
                      , thresholdForDeletion = 0.2
                      , threshold = 0.9
                      , considerWeights=TRUE
                      , plot = FALSE
                      , alpha=0.9
                      , minMinor=500)
  gating_DAPI[[i]] <- gating$best
}

# DAPI surrounding
DAPI_sur <- DAPI[["Surrounding_DAPI.fcs"]] 
fdo_sur <- mkFlowDataObject(DAPI_sur, xChannel="PMT.1", yChannel="PMT.9")
gating_sur <- flowEMMi( fdo=fdo_sur, xMin=1000, xMax=50000, yMin=1000, yMax=50000
                      , initFraction=0.01
                      , finalFraction=1.0
                      , minClusters=5, maxClusters=15, clusterbracket=2
                      , numberOfInits=5
                      , verbose=TRUE
                      , parallel=FALSE
                      , convergenceEpsilon=0.01
                      , whenToRemoveOverlaps = 20
                      , mergeWhenCenter = FALSE
                      , mergeWhenTwoCenters = FALSE
                      , thresholdForDeletion = 0.2
                      , threshold = 0.9
                      , considerWeights=TRUE
                      , plot = FALSE
                      , alpha=0.9
                      , minMinor=500)
gating_DAPI[[5]] <- gating_sur$best

```

### Gating plots on DAPI

```{r plot-DAPI,message=FALSE}
gating_DAPI_plot <- list()

for (i in 1:5){
  data_name <- names(DAPI)[i]
  data <- DAPI[[i]]
  plots <- plotDensityAndEllipses(fcsData = data, ch1="PMT.1", ch2="PMT.9", alpha=0.9,
                            logScale = F, results = gating_DAPI[[i]],
                            title = data_name, plotRelevance = T,
                            ellipseDotSize = 0.5, axis_size=10, axisLabeling_size=10,
                            xlab = "Forward Scatter", ylab = "DAPI", font = "Arial")
  gating_DAPI_plot[[i]] <- plots$plot
}
```

In the above graphs, the ellipses are colored according to their cluster probability, high probability in red, medium probability in white, low probability in blue.


## Mahalanobis distance function with flowEMMi

Following is the integrated function.

Given a preprocessed dataset and the gating result from above, it can generate the:

-   Mahalanobis distance matrix & Cluster result

-   Parameter table: Number of cells in each cluster, Area of the clustering ellipse, and the Coordinates of center

-   Gating plots

```{r}
flowEMMi_mahalanobis <- function(data,data_name,gating_data,alpha){
  
  mu <- gating_data@mu
  sigma <- gating_data@sigma
  
  names <- colnames(data)
  
  n_cells <- nrow(data)
  n_clusters <- length(sigma)
  
  #generate mahalanobis matrix
  maha_data <- matrix(NA,nrow=n_cells,ncol=n_clusters)
  
  for (i in 1:n_cells){
    for(j in 1:n_clusters){
      maha_data[i,j] <- mahalanobis(data[i,],mu[,j],sigma[[j]])
    }
  }
  
  maha <- maha_data[,2:n_clusters] %>% as.data.frame()
  
  #set 95% quantile as cutoff value
  threshold <- -2*log(1-alpha)
  
  #determine cluster
  for (cell in 1:n_cells){
    rv <- maha[cell,1:n_clusters-1]
    if(all(rv>threshold)) { maha$Cluster[cell] <- NA}
    else { maha$Cluster[cell] <- which.min(rv)}
  }
  
  maha_data2 <- cbind(data,maha)
  
  test <- table(maha[,ncol(maha)]) %>% as.data.frame()
  coordinates <- sprintf("(%.2f,%.2f)",mu[1,2:ncol(mu)],mu[2,2:ncol(mu)])
  
  #Area of Ellipse
  eigen <- matrix(NA,nrow=length(sigma),ncol=2)
  for (i in 1:length(sigma)){
    eigen[i,] <- eigen(sigma[[i]])$values
  }
  eigen <- eigen[-1,]
  
  area <- matrix(NA,nrow=nrow(eigen),ncol=1)
  for (i in 1:nrow(eigen)){
    area[i,1] <- pi*sqrt(eigen[i,1]*eigen[i,2])*(-2*log(1-alpha))
  }
  
  area <- area %>% as.data.frame()
  test <- cbind(test,area,coordinates)
  colnames(test) <- c("Cluster","Cells","Area","Coordinate")
  table <- test %>% 
    kable(caption = data_name,
          col.names = c("Cluster","Cells","Area","Coordinate"))
   
  #plot
  maha_data2$Cluster <- as.factor(maha_data2$Cluster)
  
  plot1 <- ggplot(maha_data2,aes(x=!!sym(names[1]),y=!!sym(names[2]),color=Cluster))+
    geom_point()+
    ggtitle(data_name)
  
  num_ellipse <- length(gating_data@sigma)
  
  for (j in 2:num_ellipse){
    mu <- gating_data@mu[,j]
    sigma <- gating_data@sigma[[j]]
    eli <- ellipse::ellipse(centre=mu,x=sigma,level=alpha,npoints=200) 
    eli <- as.data.frame(eli)
    colnames(eli)<- names
    plot1 <- plot1+geom_path(data = eli,
                  aes(x=!!sym(names[1]),y=!!sym(names[2])),color=j)
  }
  
  maha_result <- list(maha_matrix=maha_data2,table_info=test,table_print=table,plot=plot1)
  return(maha_result)
}
```

```{r}
flowemmi_DAPI <- list()

for (i in 1:5){
  data_name <- names(DAPI)[i]
  data <- DAPI[[i]]@exprs[,c(11,27)]
  gating_data <- gating_DAPI[[i]]
  flowemmi_DAPI[[data_name]] <-flowEMMi_mahalanobis(data,data_name,gating_data,0.9)
  print(flowemmi_DAPI[[data_name]]$table_print)
  print(flowemmi_DAPI[[data_name]]$plot)
}


```

## Clustering on different channels

We denote above sections to reveal the clustering results focusing on Forward Scatter (PMT.1) and fluorescence DAPI (PMT.9). 

Next, we'd like to explore the clustering results based on other channel selection, namely Forward Scatter vs. Side Scatter (PMT.2), and Side Scatter vs. fluorescence DAPI.

### Forward Scatter vs. Side Scatter

Gating range for regions: 0-60000

```{r diff.channel,eval=FALSE}
set.seed(1)
location <- c("Inner_zone","Middle_zone","Outer_zone","Surrounding","Whole_colony")
gating_DAPI12 <- list()


for (i in 1:5){
  data_name <- paste0(location[i],"_DAPI.fcs")
  data <- DAPI[[i]]
  fdo <- mkFlowDataObject(data, xChannel="PMT.1", yChannel="PMT.2")
  gating <- flowEMMi( fdo=fdo, xMin=0, xMax=60000, yMin=0, yMax=60000
                      , initFraction=0.01
                      , finalFraction=1.0
                      , minClusters=5, maxClusters=15, clusterbracket=2
                      , numberOfInits=5
                      , verbose=TRUE
                      , parallel=FALSE
                      , convergenceEpsilon=0.01
                      , whenToRemoveOverlaps = 20
                      , mergeWhenCenter = FALSE
                      , mergeWhenTwoCenters = FALSE
                      , thresholdForDeletion = 0.2
                      , threshold = 0.9
                      , considerWeights=TRUE
                      , plot = FALSE
                      , alpha=0.9
                      , minMinor=500)
  gating_DAPI12[[i]] <- gating$best
}

```

### Side Scatter vs. Fluorescence DAPI

```{r diff.channel2,eval=FALSE}
set.seed(1)
location <- c("Inner_zone","Middle_zone","Outer_zone","Surrounding","Whole_colony")
gating_DAPI29 <- list()


for (i in 5){
  data_name <- paste0(location[i],"_DAPI.fcs")
  data <- DAPI[[i]]
  fdo <- mkFlowDataObject(data, xChannel="PMT.2", yChannel="PMT.9")
  gating <- flowEMMi( fdo=fdo, xMin=0, xMax=60000, yMin=0, yMax=60000
                      , initFraction=0.01
                      , finalFraction=1.0
                      , minClusters=5, maxClusters=15, clusterbracket=2
                      , numberOfInits=5
                      , verbose=TRUE
                      , parallel=FALSE
                      , convergenceEpsilon=0.01
                      , whenToRemoveOverlaps = 20
                      , mergeWhenCenter = FALSE
                      , mergeWhenTwoCenters = FALSE
                      , thresholdForDeletion = 0.2
                      , threshold = 0.9
                      , considerWeights=TRUE
                      , plot = FALSE
                      , alpha=0.9
                      , minMinor=500)
  gating_DAPI29[[i]] <- gating$best
}
```


```{r,echo=F}
gating_DAPI12 <- readRDS("~/Desktop/MSc_new_data/gating_DAPI12.rds")
gating_DAPI29 <- readRDS("~/Desktop/MSc_new_data/gating_DAPI29.rds")
roc_19 <- readRDS("~/Desktop/MSc_new_data/roc_DAPI.rds")
roc_29 <- readRDS("~/Desktop/MSc_new_data/roc_DAPI29.rds")
roc_12 <- readRDS("~/Desktop/MSc_new_data/roc_DAPI12.rds")
```


## ROC

In the following section, we will ues the ROC curves to reflect the relationship between the number of cells contained in each cluster and their corresponding ellipse sizes, involving comparisons between different sampling positions.


```{r roc}
flowroc <- function(data,gating_data,ci){
  data1 <- data[,-c(1,2,ncol(data))]
  ncells <- nrow(data1)
  
  roc.points <- data.frame(cell=NA,volume=NA)
  
  for (alpha in ci){
    threshold <- -2*log(1-alpha)
  
    for (cell in 1:ncells){
      rv <- data1[cell,1:ncol(data1)-1]
      if(all(rv>threshold)) {data1$Cluster[cell] <- NA}
      else {data1$Cluster[cell] <- which.min(rv)}
    }
  
    result <- table(data1$Cluster) %>% as.data.frame()
    sum1 <- sum(result$Freq)
  
    sigma <- gating_data@sigma
  
    eigen <- matrix(NA,nrow=length(sigma),ncol=2)
    for (i in 1:length(sigma)){
      eigen[i,] <- eigen(sigma[[i]])$values
    }
    eigen <- eigen[-1,]
  
    area <- matrix(NA,nrow=nrow(eigen),ncol=1)
    for (i in 1:nrow(eigen)){
      area[i,1] <- pi*sqrt(eigen[i,1]*eigen[i,2])*(-2*log(1-alpha))
    }
    area <- as.data.frame(area)
    sum2 <- sum(area)
    sum.roc <- cbind(cell=sum1,volume=sum2)
    
    roc.points <- rbind(roc.points,sum.roc)
  }
  return(roc.table=roc.points)
}
```



```{r roc2,eval=FALSE}
roc.result <- list()

# calculate roc points
for (i in 1:5){
  data_name <- names(DAPI)[i]
  data <- flowemmi_DAPI[[data_name]]$maha_matrix
  
  dname <- substr(data_name,1,nchar(data_name)-9)
  gating_data <- gating_DAPI[[dname]]
  alpha <- seq(0.01,0.99,0.01)
  
  roc.result[[data_name]] <- flowroc(data,gating_data,alpha)
}

```

After computing the sum of cells' number and the ellipse volume at different confidence intervals, we can now plot the ROC curves to compare the trade-off tendency for different locations.

```{r roc-plot}
# plot
plot.roc <- function(roc_result,plot_title){
  
  plot.points <- data.frame()
  plot.scale <- data.frame()
  plot.scale.points <- data.frame()

  for (i in 1:5){
    data <- roc_result[[i]]
    data[1,] <- c(0,0)
  
  # No Scaling
  data$location <- substr(names(DAPI)[i],1,nchar(names(DAPI)[i])-9) %>% as.factor()
  plot.points <- rbind(plot.points,data)
  
  # Scaled by regional maximum
  max <- data[100,]
  for (j in 1:100){
    data[j,1] <- data[j,1]/max[1,1]
    data[j,2] <- data[j,2]/max[1,2]
  }
  plot.scale <- rbind(plot.scale,data)
  
  
  # Scaled by the max number among all regions
  plot.scale.points <- plot.points
  
  for (j in 1:nrow(plot.points)){
    plot.scale.points[j,1]<- plot.scale.points[j,1]/max(plot.scale.points[,1])
    plot.scale.points[j,2]<- plot.scale.points[j,2]/max(plot.scale.points[,2])
    }
  }
  
  #return(raw.point=plot.points,reginal.scaled=plot.scale,all.scaled=plot.scale.points)

  print(ggplot(plot.points, aes(x = volume, y = cell, color = location)) +
    geom_line() +
    labs(x = "volume", y = "cell", title = plot_title, subtitle = "Without scaling") +
    theme_minimal())

  print(ggplot(plot.scale, aes(x = volume, y = cell, color = location)) +
    geom_line() +
    labs(x = "volume", y = "cell", title = plot_title, subtitle = "Scaled by each regional maximum") +
    theme_minimal())

  print(ggplot(plot.scale.points, aes(x = volume, y = cell, color = location)) +
    geom_line() +
    labs(x = "volume", y = "cell", title = plot_title, subtitle = "Scaled by max number over all regions") +
    theme_minimal())
}
```

```{r}
plot.roc12 <- plot.roc(roc_12,"DAPI ROC: FSC vs. SSC")
plot.roc29 <- plot.roc(roc_29,"DAPI ROC: SSC vs. DAPI")
plot.roc19 <- plot.roc(roc_19,"DAPI ROC: FSC vs. DAPI")
```

## Metaclustering

In order to get meta-clustering results, firstly we merge all gating results regardless of regions, then run the flowEMMI package to remove the overlap ellipses.

Next, we compute the mahalanobis distance and roc curves.

```{r}
#PMT.1--Forward Scatter--col11
#PMT.2--Side Scatter--col13
#PMT.9--Fluor. DAPI--col27

all_data <- DAPI[[1]]@exprs[,c(11,27)]
all_gate <- gating_DAPI[[1]]

  for (i in 2:5){
    mu <- gating_DAPI[[i]]@mu[,-1]
    sigma <- gating_DAPI[[i]]@sigma[-1]
    prob <- gating_DAPI[[i]]@clusterProbs[-1]
    all_gate@mu <- cbind(all_gate@mu,mu)
    all_gate@sigma <- c(all_gate@sigma,sigma)
    all_gate@clusterProbs <- c(all_gate@clusterProbs,prob)
    
    data <- DAPI[[i]]@exprs[,c(11,27)]
    all_data <- rbind(all_data,data)
}

new_all_gate <- removeOverlaps(em=all_gate, alpha=0.9
                                  , mergeWhenCenter = FALSE
                                  , mergeWhenTwoCenters = FALSE
                                  , thresholdForDeletion = 0.2
                                  , threshold = 0.9
                                  , shrinkingFunction=shrinkEllipses
                                  , considerWeights=TRUE
                                  , plot = FALSE
                                  , minMinor = 500)

maha_all <- flowEMMi_mahalanobis(all_data,"Meta-cluster",new_all_gate,0.9)
print(maha_all$table_print)
print(maha_all$plot)

#alpha <- seq(0.01,0.99,0.01)
#roc_all <- flowroc(maha_all$maha_matrix,new_all_gate,alpha)

```


## Files written

These files have been written to the target directory, `r paste0("data/", params$name)`:

```{r list-files-target}
projthis::proj_dir_info(path_target())
```
